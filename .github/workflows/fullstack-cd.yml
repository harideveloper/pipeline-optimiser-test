name: Full Stack CD - Build, Test & Deploy

on:
  workflow_run:
    workflows: ["Full Stack Linter CI"]
    types: [completed]

jobs:
  build-and-test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/myapp-backend:${{ github.sha }} ./app/backend

      - name: Build frontend image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/myapp-frontend:${{ github.sha }} ./app/frontend

      - name: Push images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/myapp-backend:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/myapp-frontend:${{ github.sha }}

  integration-tests:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start containers
        run: |
          docker compose up -d
          sleep 5
          docker ps

      - name: Verify backend endpoint
        run: |
          curl -f http://localhost:3000 || (echo "‚ùå Backend failed health check" && exit 1)

      - name: Verify frontend endpoint
        run: |
          curl -f http://localhost:8080 || (echo "‚ùå Frontend failed health check" && exit 1)

      - name: Tear down
        if: always()
        run: docker compose down

  deploy:
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - name: Simulate production deployment
        run: |
          echo "üöÄ Deploying version ${{ github.sha }} to production environment..."
          echo "‚úÖ Backend and frontend images deployed successfully!"
